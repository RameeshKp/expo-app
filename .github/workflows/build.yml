name: CI/CD Build

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-play-store:
    name: Build for Google Play Store
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Inject Play Store Keystore
        env:
          PLAY_STORE_KEYSTORE: ${{ secrets.PLAY_STORE_KEYSTORE_BASE64 }}
          PLAY_STORE_CREDENTIALS: ${{ secrets.PLAY_STORE_CREDENTIALS_JSON }}
        run: |
          if [ -n "$PLAY_STORE_KEYSTORE" ]; then
            echo "$PLAY_STORE_KEYSTORE" | base64 --decode > play-store.jks
            echo "$PLAY_STORE_CREDENTIALS" > credentials.json
          fi

      - name: Build Android for Play Store
        run: eas build --profile production --platform android --non-interactive --no-wait

  build-solana:
    name: Build for Solana App Store
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"

      - name: Setup Expo
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install dependencies
        run: npm install

      - name: Inject Solana Keystore
        env:
          SOLANA_KEYSTORE: ${{ secrets.SOLANA_KEYSTORE_BASE64 }}
          SOLANA_CREDENTIALS: ${{ secrets.SOLANA_CREDENTIALS_JSON }}
        run: |
          if [ -n "$SOLANA_KEYSTORE" ]; then
            echo "$SOLANA_KEYSTORE" | base64 --decode > solana.jks
            echo "$SOLANA_CREDENTIALS" > credentials.json
          fi

      - name: Build Android for Solana
        run: eas build --profile solana --platform android --non-interactive --no-wait
